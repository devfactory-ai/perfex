# Perfex API Worker Configuration
name = "perfex-api"
main = "src/index.ts"
compatibility_date = "2024-11-24"
# account_id is set via CLOUDFLARE_ACCOUNT_ID environment variable

# Node.js compatibility
compatibility_flags = ["nodejs_compat"]

# ===============================================
# DEV ENVIRONMENT (default/preview)
# ===============================================
[env.dev]
name = "perfex-api-dev"
vars = { ENVIRONMENT = "development", LOG_LEVEL = "debug" }

[[env.dev.d1_databases]]
binding = "DB"
database_name = "perfex-db-dev"
database_id = "ee413e83-d9ff-4537-910b-1518c21c411d"
migrations_dir = "../../../packages/database/migrations"

[[env.dev.kv_namespaces]]
binding = "SESSIONS"
id = "2f01fde43e7948b9b8c675eb2c071a53"

[[env.dev.kv_namespaces]]
binding = "CACHE"
id = "91daa70dba574f4ea2817fe3e6c4e697"

[env.dev.ai]
binding = "AI"

# Cron Triggers for dev
[env.dev.triggers]
crons = [
  "0 * * * *",     # Every hour - Session cleanup
  "0 6 * * *",     # Daily at 6 AM - Risk assessments
  "0 0 * * *",     # Daily at midnight - Overdue task check
  "0 7 * * 1",     # Weekly Monday 7 AM - Reports
  "0 1 * * *",     # Daily at 1 AM - Process scheduled audits
]

# ===============================================
# STAGING ENVIRONMENT (Perfex Health - Sant√©)
# ===============================================
[env.staging]
name = "perfex-api-staging"
vars = { ENVIRONMENT = "staging", LOG_LEVEL = "info" }

[[env.staging.d1_databases]]
binding = "DB"
database_name = "perfex-db-staging"
database_id = "3c3e455c-82ec-45f0-9353-3519cb47d2a0"
migrations_dir = "../../../packages/database/migrations"

[[env.staging.kv_namespaces]]
binding = "SESSIONS"
id = "56e331308c3e4e008d8e0f50b3f0c2cf"

[[env.staging.kv_namespaces]]
binding = "CACHE"
id = "8196619e43724dc3a80f93a2e9cdc8cd"

[env.staging.ai]
binding = "AI"

# Cron Triggers for staging
[env.staging.triggers]
crons = [
  "0 * * * *",     # Every hour - Session cleanup
  "0 6 * * *",     # Daily at 6 AM - Risk assessments
  "0 0 * * *",     # Daily at midnight - Overdue task check
  "0 7 * * 1",     # Weekly Monday 7 AM - Reports
  "0 1 * * *",     # Daily at 1 AM - Process scheduled audits
]

# ===============================================
# PRODUCTION ENVIRONMENT
# ===============================================
[env.production]
name = "perfex-api"
vars = { ENVIRONMENT = "production", LOG_LEVEL = "warn" }

[[env.production.d1_databases]]
binding = "DB"
database_name = "perfex-db-prod"
database_id = "709639fa-b262-4d3d-aa8d-8e5120c59681"
migrations_dir = "../../../packages/database/migrations"

[[env.production.kv_namespaces]]
binding = "SESSIONS"
id = "597b6e9781e1490eb2128c51b237d434"

[[env.production.kv_namespaces]]
binding = "CACHE"
id = "7a8a7cc6db774253aa10ff3faba949b6"

[env.production.ai]
binding = "AI"

# Cron Triggers for production
[env.production.triggers]
crons = [
  "0 * * * *",     # Every hour - Session cleanup
  "0 6 * * *",     # Daily at 6 AM - Risk assessments
  "0 0 * * *",     # Daily at midnight - Overdue task check
  "0 7 * * 1",     # Weekly Monday 7 AM - Reports
  "0 1 * * *",     # Daily at 1 AM - Process scheduled audits
]
